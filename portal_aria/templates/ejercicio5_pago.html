<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <meta name="description" content="{{ descripcion }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .checkout-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .checkout-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .progress-header {
            background: linear-gradient(90deg, #007bff, #0056b3);
            color: white;
            padding: 2rem;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 2;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgb(0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: white;
            color: #000000;
        }
        
        .step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            text-align: center;
            opacity: 0.8;
        }
        
        .step.active .step-title {
            opacity: 1;
            font-weight: 500;
        }
        
        .step-connector {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        
        .checkout-content {
            padding: 3rem;
        }
        
        .step-panel {
            display: none;
        }
        
        .step-panel.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #000000;
        }
        
        .payment-method {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .payment-method.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .order-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            position: sticky;
            top: 2rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 3rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #28a745;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }
        
        /* PROBLEMAS INTENCIONADOS */
        .error-state {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
        }
        
        .field-error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .required::after {
            content: " *";
            color: #dc3545;
        }
        
        .card-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>

<body>
    <!-- PROBLEMA: Falta skip link (HECHO)-->

    <div class="skip-link">
        <a href="#mainContent" class="btn btn-primary">Saltar al contenido principal</a>
    </div>

    <div class="checkout-container">
        <div class="container">
            
            <!-- Navegaci√≥n de regreso -->
            <div class="mb-3">
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    ‚Üê Volver al portal
                </a>
            </div>
            
            <div class="checkout-card">
                
                <!-- PROBLEMA: Header de progreso sin accesibilidad -->
                <div class="progress-header">
                    <!-- PROBLEMA: T√≠tulo sin estructura apropiada -->
                    <div style="font-size: 1.8rem; font-weight: 300; margin-bottom: 2rem; text-align: center;">
                        Proceso de Pago Seguro
                    </div>
                    
                    <!-- PROBLEMA: Indicador de pasos sin accesibilidad -->
                    <div class="step-indicator">
                        <div class="step-connector"></div>
                        
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-title">Informaci√≥n Personal</div>
                        </div>
                        
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-title">Env√≠o y Facturaci√≥n</div>
                        </div>
                        
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-title">M√©todo de Pago</div>
                        </div>
                        
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-title">Confirmaci√≥n</div>
                        </div>
                    </div>
                </div>
                
                <!-- PROBLEMA: Contenido principal sin landmark -->
                <div id="mainContent" class="checkout-content">
                    <div class="row">
                        
                        <!-- Columna principal del formulario -->
                        <div class="col-lg-8">
                            
                            <!-- PROBLEMA: Formulario sin estructura accesible -->
                            <form id="checkoutForm" novalidate>
                                
                                <!-- PASO 1: Informaci√≥n Personal - M√öLTIPLES PROBLEMAS -->
                                <div class="step-panel active" data-panel="1">
                                    <!-- PROBLEMA: Sin fieldset para agrupar -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            üë§ Informaci√≥n Personal
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <!-- PROBLEMA: Label sin asociaci√≥n -->
                                                <div class="form-label required">Nombre</div>
                                                <input type="text" 
                                                       class="form-control" 
                                                       name="firstName"
                                                       placeholder="Tu nombre"
                                                       autocomplete="given-name">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <div class="form-label required">Apellidos</div>
                                                <input type="text" 
                                                       class="form-control" 
                                                       name="lastName"
                                                       placeholder="Tus apellidos"
                                                       autocomplete="family-name">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <div class="form-label required">Correo electr√≥nico</div>
                                                <input type="email" 
                                                       class="form-control" 
                                                       name="email"
                                                       placeholder="tu@email.com"
                                                       autocomplete="email">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                            
                                            <div class="col-md-4 mb-3">
                                                <div class="form-label required">Tel√©fono</div>
                                                <input type="tel" 
                                                       class="form-control" 
                                                       name="phone"
                                                       placeholder="+34 600 000 000"
                                                       autocomplete="tel">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- PROBLEMA: Checkbox sin estructura accesible -->
                                        <div class="mb-3">
                                            <input type="checkbox" name="createAccount" style="margin-right: 0.5rem;">
                                            <span>Crear una cuenta para futuras compras m√°s r√°pidas</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Botones de navegaci√≥n - PROBLEMAS -->
                                    <div style="display: flex; justify-content: end; gap: 1rem;">
                                        <!-- PROBLEMA: Bot√≥n sin descripci√≥n de acci√≥n -->
                                        <button type="button" 
                                                onclick="nextStep()"
                                                class="btn btn-primary btn-lg">
                                            Continuar ‚Üí
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- PASO 2: Env√≠o y Facturaci√≥n - PROBLEMAS -->
                                <div class="step-panel" data-panel="2">
                                    
                                    <!-- Direcci√≥n de env√≠o -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            üöö Direcci√≥n de Env√≠o
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <div class="form-label required">Direcci√≥n</div>
                                                <input type="text" 
                                                       class="form-control" 
                                                       name="address"
                                                       placeholder="Calle, n√∫mero, piso, puerta"
                                                       autocomplete="street-address">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-label required">Ciudad</div>
                                                <input type="text" 
                                                       class="form-control" 
                                                       name="city"
                                                       placeholder="Tu ciudad"
                                                       autocomplete="address-level2">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <div class="form-label required">C√≥digo Postal</div>
                                                <input type="text" 
                                                       class="form-control" 
                                                       name="postalCode"
                                                       placeholder="28001"
                                                       autocomplete="postal-code">
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <!-- PROBLEMA: Select sin label apropiado -->
                                                <div class="form-label required">Pa√≠s</div>
                                                <select class="form-select" name="country" autocomplete="country">
                                                    <option value="">Selecciona pa√≠s</option>
                                                    <option value="ES">Espa√±a</option>
                                                    <option value="FR">Francia</option>
                                                    <option value="DE">Alemania</option>
                                                    <option value="IT">Italia</option>
                                                    <option value="PT">Portugal</option>
                                                </select>
                                                <div class="field-error" style="display: none;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Opciones de env√≠o - PROBLEMAS -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            üì¶ Opciones de Env√≠o
                                        </div>
                                        
                                        <!-- PROBLEMA: Radio buttons sin fieldset -->
                                        <div style="margin-bottom: 1rem;">
                                            <!-- PROBLEMA: Radio sin label apropiado -->
                                            <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 1rem; margin-bottom: 0.5rem; cursor: pointer;"
                                                 onclick="selectShipping('standard')">
                                                <input type="radio" name="shipping" value="standard" style="margin-right: 0.5rem;">
                                                <strong>Env√≠o Est√°ndar (5-7 d√≠as)</strong> - Gratis
                                                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">
                                                    Entrega en horario laboral
                                                </div>
                                            </div>
                                            
                                            <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 1rem; margin-bottom: 0.5rem; cursor: pointer;"
                                                 onclick="selectShipping('express')">
                                                <input type="radio" name="shipping" value="express" style="margin-right: 0.5rem;">
                                                <strong>Env√≠o Express (2-3 d√≠as)</strong> - ‚Ç¨9.99
                                                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">
                                                    Entrega garantizada en 2-3 d√≠as h√°biles
                                                </div>
                                            </div>
                                            
                                            <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 1rem; margin-bottom: 0.5rem; cursor: pointer;"
                                                 onclick="selectShipping('overnight')">
                                                <input type="radio" name="shipping" value="overnight" style="margin-right: 0.5rem;">
                                                <strong>Env√≠o 24h</strong> - ‚Ç¨19.99
                                                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;">
                                                    Entrega al d√≠a siguiente antes de las 12:00
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Facturaci√≥n -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            üßæ Informaci√≥n de Facturaci√≥n
                                        </div>
                                        
                                        <!-- PROBLEMA: Checkbox sin accesibilidad -->
                                        <div class="mb-3">
                                            <input type="checkbox" 
                                                   name="sameAsShipping" 
                                                   checked 
                                                   onchange="toggleBillingAddress()"
                                                   style="margin-right: 0.5rem;">
                                            <span>La direcci√≥n de facturaci√≥n es igual a la de env√≠o</span>
                                        </div>
                                        
                                        <!-- PROBLEMA: Secci√≥n colapsable sin accesibilidad -->
                                        <div id="billingAddressSection" style="display: none;">
                                            <div class="row">
                                                <div class="col-12 mb-3">
                                                    <div class="form-label">Direcci√≥n de facturaci√≥n</div>
                                                    <input type="text" class="form-control" name="billingAddress">
                                                </div>
                                            </div>
                                            <!-- M√°s campos de facturaci√≥n... -->
                                        </div>
                                    </div>
                                    
                                    <!-- Botones de navegaci√≥n -->
                                    <div style="display: flex; justify-content: space-between;">
                                        <button type="button" 
                                                onclick="prevStep()"
                                                class="btn btn-outline-secondary btn-lg">
                                            ‚Üê Anterior
                                        </button>
                                        <button type="button" 
                                                onclick="nextStep()"
                                                class="btn btn-primary btn-lg">
                                            Continuar ‚Üí
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- PASO 3: M√©todo de Pago - PROBLEMAS CR√çTICOS -->
                                <div class="step-panel" data-panel="3">
                                    
                                    <div class="form-section">
                                        <div class="section-title">
                                            üí≥ M√©todo de Pago
                                        </div>
                                        
                                        <!-- PROBLEMA: M√©todos de pago sin fieldset -->
                                        <div style="margin-bottom: 2rem;">
                                            
                                            <!-- Tarjeta de cr√©dito -->
                                            <div class="payment-method" onclick="selectPaymentMethod('card')">
                                                <!-- PROBLEMA: Radio sin label -->
                                                <input type="radio" name="paymentMethod" value="card" style="margin-right: 0.5rem;">
                                                <strong>üí≥ Tarjeta de Cr√©dito/D√©bito</strong>
                                                <div style="font-size: 0.9rem; color: #6c757d;">
                                                    Visa, Mastercard, American Express
                                                </div>
                                            </div>
                                            
                                            <!-- PayPal -->
                                            <div class="payment-method" onclick="selectPaymentMethod('paypal')">
                                                <input type="radio" name="paymentMethod" value="paypal" style="margin-right: 0.5rem;">
                                                <strong>üîµ PayPal</strong>
                                                <div style="font-size: 0.9rem; color: #6c757d;">
                                                    Paga de forma segura con tu cuenta PayPal
                                                </div>
                                            </div>
                                            
                                            <!-- Transferencia -->
                                            <div class="payment-method" onclick="selectPaymentMethod('transfer')">
                                                <input type="radio" name="paymentMethod" value="transfer" style="margin-right: 0.5rem;">
                                                <strong>üè¶ Transferencia Bancaria</strong>
                                                <div style="font-size: 0.9rem; color: #6c757d;">
                                                    Recibir√°s las instrucciones por email
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- PROBLEMA: Secci√≥n tarjeta sin accesibilidad -->
                                        <div id="cardDetails" style="display: none;">
                                            
                                            <!-- Vista previa de tarjeta - PROBLEMA: Solo visual -->
                                            <div class="card-preview">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                                    <span>BANCO EJEMPLO</span>
                                                    <span id="cardType">VISA</span>
                                                </div>
                                                <div style="font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 1rem;" id="cardNumberDisplay">
                                                    **** **** **** ****
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <div>
                                                        <div style="font-size: 0.7rem; opacity: 0.8;">TITULAR</div>
                                                        <div id="cardHolderDisplay">NOMBRE APELLIDOS</div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 0.7rem; opacity: 0.8;">V√ÅLIDA HASTA</div>
                                                        <div id="cardExpiryDisplay">MM/AA</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-12 mb-3">
                                                    <!-- PROBLEMA: Campo tarjeta sin descripci√≥n accesible -->
                                                    <div class="form-label required">N√∫mero de tarjeta</div>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           name="cardNumber"
                                                           placeholder="1234 5678 9012 3456"
                                                           maxlength="19"
                                                           autocomplete="cc-number"
                                                           oninput="formatCardNumber(this)">
                                                    <div class="field-error" style="display: none;"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-8 mb-3">
                                                    <div class="form-label required">Nombre del titular</div>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           name="cardHolder"
                                                           placeholder="Como aparece en la tarjeta"
                                                           autocomplete="cc-name"
                                                           oninput="updateCardPreview()">
                                                    <div class="field-error" style="display: none;"></div>
                                                </div>
                                                
                                                <div class="col-md-4 mb-3">
                                                    <!-- PROBLEMA: CVV sin explicaci√≥n accesible -->
                                                    <div class="form-label required">
                                                        CVV
                                                        <!-- PROBLEMA: Icono de ayuda sin accesibilidad -->
                                                        <span style="cursor: help; color: #007bff;" onclick="showCVVHelp()">‚ÑπÔ∏è</span>
                                                    </div>
                                                    <input type="password" 
                                                           class="form-control" 
                                                           name="cvv"
                                                           placeholder="123"
                                                           maxlength="4"
                                                           autocomplete="cc-csc">
                                                    <div class="field-error" style="display: none;"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-label required">Mes de expiraci√≥n</div>
                                                    <!-- PROBLEMA: Select sin opciones accesibles -->
                                                    <select class="form-select" 
                                                            name="expiryMonth" 
                                                            autocomplete="cc-exp-month"
                                                            onchange="updateCardPreview()">
                                                        <option value="">Mes</option>
                                                        <option value="01">01</option>
                                                        <option value="02">02</option>
                                                        <option value="03">03</option>
                                                        <option value="04">04</option>
                                                        <option value="05">05</option>
                                                        <option value="06">06</option>
                                                        <option value="07">07</option>
                                                        <option value="08">08</option>
                                                        <option value="09">09</option>
                                                        <option value="10">10</option>
                                                        <option value="11">11</option>
                                                        <option value="12">12</option>
                                                    </select>
                                                    <div class="field-error" style="display: none;"></div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-label required">A√±o de expiraci√≥n</div>
                                                    <select class="form-select" 
                                                            name="expiryYear" 
                                                            autocomplete="cc-exp-year"
                                                            onchange="updateCardPreview()">
                                                        <option value="">A√±o</option>
                                                        <option value="2024">2024</option>
                                                        <option value="2025">2025</option>
                                                        <option value="2026">2026</option>
                                                        <option value="2027">2027</option>
                                                        <option value="2028">2028</option>
                                                        <option value="2029">2029</option>
                                                        <option value="2030">2030</option>
                                                    </select>
                                                    <div class="field-error" style="display: none;"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- PROBLEMA: Checkbox guardar tarjeta sin contexto -->
                                            <div class="mb-3">
                                                <input type="checkbox" name="saveCard" style="margin-right: 0.5rem;">
                                                <span>Guardar esta tarjeta para futuras compras</span>
                                                <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.25rem;">
                                                    Tus datos se almacenar√°n de forma segura y encriptada
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Botones de navegaci√≥n -->
                                    <div style="display: flex; justify-content: space-between;">
                                        <button type="button" 
                                                onclick="prevStep()"
                                                class="btn btn-outline-secondary btn-lg">
                                            ‚Üê Anterior
                                        </button>
                                        <button type="button" 
                                                onclick="nextStep()"
                                                class="btn btn-primary btn-lg">
                                            Revisar Pedido ‚Üí
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- PASO 4: Confirmaci√≥n - PROBLEMAS -->
                                <div class="step-panel" data-panel="4">
                                    
                                    <div class="form-section">
                                        <div class="section-title">
                                            ‚úÖ Confirmaci√≥n de Pedido
                                        </div>
                                        
                                        <!-- PROBLEMA: Resumen sin estructura accesible -->
                                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                                            
                                            <!-- Resumen de informaci√≥n personal -->
                                            <div style="margin-bottom: 1.5rem;">
                                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #007bff;">
                                                    Informaci√≥n Personal
                                                </div>
                                                <div id="personalSummary">
                                                    <!-- Se completar√° din√°micamente -->
                                                </div>
                                            </div>
                                            
                                            <!-- Resumen de env√≠o -->
                                            <div style="margin-bottom: 1.5rem;">
                                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #007bff;">
                                                    Direcci√≥n de Env√≠o
                                                </div>
                                                <div id="shippingSummary">
                                                    <!-- Se completar√° din√°micamente -->
                                                </div>
                                            </div>
                                            
                                            <!-- Resumen de pago -->
                                            <div style="margin-bottom: 1.5rem;">
                                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #007bff;">
                                                    M√©todo de Pago
                                                </div>
                                                <div id="paymentSummary">
                                                    <!-- Se completar√° din√°micamente -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- PROBLEMA: T√©rminos finales sin accesibilidad -->
                                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                            <div style="font-weight: 500; margin-bottom: 0.5rem;">
                                                ‚ö†Ô∏è T√©rminos y Condiciones Finales
                                            </div>
                                            <div class="mb-2">
                                                <input type="checkbox" name="acceptTerms" required style="margin-right: 0.5rem;">
                                                <span>
                                                    Acepto los 
                                                    <!-- PROBLEMA: Link sin indicar nueva ventana -->
                                                    <a href="#" target="_blank">t√©rminos y condiciones de venta</a>
                                                </span>
                                            </div>
                                            <div class="mb-2">
                                                <input type="checkbox" name="acceptPrivacy" required style="margin-right: 0.5rem;">
                                                <span>
                                                    He le√≠do la 
                                                    <a href="#" target="_blank">pol√≠tica de privacidad</a>
                                                </span>
                                            </div>
                                            <div class="mb-2">
                                                <input type="checkbox" name="acceptRefund" required style="margin-right: 0.5rem;">
                                                <span>
                                                    Entiendo la 
                                                    <a href="#" target="_blank">pol√≠tica de devoluciones</a>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Botones finales -->
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <button type="button" 
                                                onclick="prevStep()"
                                                class="btn btn-outline-secondary btn-lg">
                                            ‚Üê Anterior
                                        </button>
                                        
                                        <div style="text-align: center;">
                                            <!-- PROBLEMA: Total sin formato accesible -->
                                            <div style="font-size: 1.1rem; color: #6c757d; margin-bottom: 0.5rem;">
                                                Total a pagar:
                                            </div>
                                            <div style="font-size: 2rem; font-weight: bold; color: #007bff;">
                                                ‚Ç¨1,848.96
                                            </div>
                                        </div>
                                        
                                        <!-- PROBLEMA: Bot√≥n final sin indicar proceso -->
                                        <button type="submit" 
                                                class="btn btn-success btn-lg"
                                                style="font-size: 1.2rem; padding: 1rem 2rem;">
                                            üí≥ Realizar Pago
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- PROBLEMA: Sidebar resumen sin landmark -->
                        <div class="col-lg-4">
                            <div class="order-summary">
                                <!-- PROBLEMA: Resumen sin estructura sem√°ntica -->
                                <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center;">
                                    üìã Resumen del Pedido
                                </div>
                                
                                <!-- Lista de productos - PROBLEMA: Sin estructura -->
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #dee2e6;">
                                        <div>
                                            <div style="font-weight: 500;">Laptop Gaming Pro X1</div>
                                            <div style="font-size: 0.9rem; color: #000000;">Cantidad: 1</div>
                                        </div>
                                        <div style="font-weight: 500;">‚Ç¨1,299.99</div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #dee2e6;">
                                        <div>
                                            <div style="font-weight: 500;">Auriculares Wireless Pro</div>
                                            <div style="font-size: 0.9rem; color: #000000;">Cantidad: 2</div>
                                        </div>
                                        <div style="font-weight: 500;">‚Ç¨399.98</div>
                                    </div>
                                </div>
                                
                                <!-- Totales - PROBLEMA: Sin estructura sem√°ntica -->
                                <div style="border-top: 2px solid #dee2e6; padding-top: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Subtotal:</span>
                                        <span>‚Ç¨1,699.97</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Env√≠o:</span>
                                        <span id="shippingCost">‚Ç¨0.00</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Impuestos (21%):</span>
                                        <span>‚Ç¨356.99</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                        <span>Descuento:</span>
                                        <span style="color: #000000;">-‚Ç¨208.00</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; border-top: 2px solid #007bff; padding-top: 1rem;">
                                        <span>Total:</span>
                                        <span style="color: #007bff;">‚Ç¨1,848.96</span>
                                    </div>
                                </div>
                                
                                <!-- PROBLEMA: C√≥digo promocional sin accesibilidad -->
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">¬øTienes un c√≥digo promocional?</div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <!-- PROBLEMA: Input sin label -->
                                        <input type="text" 
                                               class="form-control" 
                                               placeholder="C√≥digo promocional"
                                               id="promoCode">
                                        <button onclick="applyPromoCode()" class="btn btn-outline-primary" style="color: #000000;">
                                            Aplicar
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Garant√≠as y seguridad -->
                                <div style="margin-top: 1.5rem; font-size: 0.9rem; color: #000000; text-align: center;">
                                    <div style="margin-bottom: 0.5rem;">üîí Pago 100% seguro</div>
                                    <div style="margin-bottom: 0.5rem;">üìû Soporte 24/7</div>
                                    <div style="margin-bottom: 0.5rem;">üì¶ Garant√≠a de 30 d√≠as</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PROBLEMA: Overlays sin accesibilidad -->
    <div class="loading-overlay" id="processingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;"></div>
            <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 0.5rem;">
                Procesando pago...
            </div>
            <div style="color: #6c757d;">
                Por favor, no cierres esta ventana
            </div>
            <!-- PROBLEMA: Progreso sin informaci√≥n accesible -->
            <div style="margin-top: 1.5rem;">
                <div style="background: #e9ecef; height: 4px; border-radius: 2px; overflow: hidden;">
                    <div id="processingProgress" style="background: #007bff; height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <div id="processingStep" style="margin-top: 0.5rem; font-size: 0.9rem; color: #6c757d;">
                    Validando informaci√≥n...
                </div>
            </div>
        </div>
    </div>
    
    <!-- PROBLEMA: Modal √©xito sin accesibilidad -->
    <div class="loading-overlay" id="successOverlay" style="display: none;">
        <div class="loading-content">
            <div class="success-checkmark">
                ‚úì
            </div>
            <div style="font-size: 1.5rem; font-weight: 500; margin-bottom: 1rem; color: #28a745;">
                ¬°Pago Completado!
            </div>
            <div style="color: #6c757d; margin-bottom: 1.5rem;">
                Tu pedido ha sido procesado exitosamente
            </div>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                <div style="font-size: 0.9rem; color: #6c757d;">N√∫mero de pedido:</div>
                <div style="font-family: monospace; font-size: 1.1rem; font-weight: bold;">#TH-2025-001234</div>
            </div>
            <button onclick="closeSuccess()" class="btn btn-primary">
                Continuar
            </button>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/portal.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // M√öLTIPLES PROBLEMAS INTENCIONADOS DE ACCESIBILIDAD
        
        let currentStep = 1;
        const totalSteps = 4;
        let formData = {};
        
        // PROBLEMA: Navegaci√≥n entre pasos sin accesibilidad
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    // PROBLEMA: No anuncia el cambio de paso
                    hideStep(currentStep);
                    currentStep++;
                    showStep(currentStep);
                    updateStepIndicator();
                    
                    // PROBLEMA: No maneja el foco apropiadamente
                    window.scrollTo(0, 0);
                }
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                hideStep(currentStep);
                currentStep--;
                showStep(currentStep);
                updateStepIndicator();
                
                // PROBLEMA: No enfoca elemento apropiado
                window.scrollTo(0, 0);
            }
        }
        
        // PROBLEMA: Mostrar/ocultar pasos sin accesibilidad
        function showStep(stepNumber) {
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            const panel = document.querySelector(`[data-panel="${stepNumber}"]`);
            if (panel) {
                panel.classList.add('active');
                // PROBLEMA: No usa aria-hidden apropiadamente
            }
        }
        
        function hideStep(stepNumber) {
            const panel = document.querySelector(`[data-panel="${stepNumber}"]`);
            if (panel) {
                panel.classList.remove('active');
                // PROBLEMA: No actualiza estados ARIA
            }
        }
        
        // PROBLEMA: Actualizar indicador sin accesibilidad
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
                
                // PROBLEMA: No actualiza aria-current o similar
            });
        }
        
        // PROBLEMA: Validaci√≥n sin feedback accesible
        function validateCurrentStep() {
            const currentPanel = document.querySelector(`[data-panel="${currentStep}"]`);
            const requiredFields = currentPanel.querySelectorAll('[required], .required ~ input, .required ~ select');
            
            let isValid = true;
            let firstError = null;
            
            // PROBLEMA: Limpiar errores no accesible
            currentPanel.querySelectorAll('.field-error').forEach(error => {
                error.style.display = 'none';
                error.textContent = '';
            });
            
            currentPanel.querySelectorAll('.form-control, .form-select').forEach(field => {
                field.classList.remove('error-state');
            });
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    
                    // PROBLEMA: Error no accesible
                    field.classList.add('error-state');
                    const errorDiv = field.parentNode.querySelector('.field-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = 'Este campo es requerido';
                        // PROBLEMA: No usa aria-invalid
                    }
                    
                    if (!firstError) firstError = field;
                }
            });
            
            // Validaciones espec√≠ficas
            if (currentStep === 1) {
                const email = currentPanel.querySelector('[name="email"]');
                if (email.value && !isValidEmail(email.value)) {
                    isValid = false;
                    showFieldError(email, 'Email inv√°lido');
                }
            }
            
            if (currentStep === 3) {
                const paymentMethod = currentPanel.querySelector('[name="paymentMethod"]:checked');
                if (!paymentMethod) {
                    isValid = false;
                    // PROBLEMA: Error de grupo no accesible
                    alert('Selecciona un m√©todo de pago');
                }
                
                if (paymentMethod && paymentMethod.value === 'card') {
                    // Validar campos de tarjeta
                    const cardNumber = currentPanel.querySelector('[name="cardNumber"]');
                    if (cardNumber.value && !isValidCardNumber(cardNumber.value)) {
                        isValid = false;
                        showFieldError(cardNumber, 'N√∫mero de tarjeta inv√°lido');
                    }
                }
            }
            
            if (currentStep === 4) {
                const checkboxes = currentPanel.querySelectorAll('[name="acceptTerms"], [name="acceptPrivacy"], [name="acceptRefund"]');
                checkboxes.forEach(cb => {
                    if (!cb.checked) {
                        isValid = false;
                        // PROBLEMA: Error de checkbox no accesible
                        showFieldError(cb, 'Debes aceptar este t√©rmino');
                    }
                });
            }
            
            if (!isValid && firstError) {
                // PROBLEMA: Foco no maneja casos edge
                firstError.focus();
            }
            
            return isValid;
        }
        
        // PROBLEMA: Mostrar error sin accesibilidad
        function showFieldError(field, message) {
            field.classList.add('error-state');
            const errorDiv = field.parentNode.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = message;
                // PROBLEMA: No asocia error con campo
            }
        }
        
        // PROBLEMA: Seleccionar m√©todo de pago sin accesibilidad
        function selectPaymentMethod(method) {
            // Limpiar selecciones previas
            document.querySelectorAll('.payment-method').forEach(pm => {
                pm.classList.remove('selected');
            });
            
            // Seleccionar m√©todo actual
            const selectedMethod = document.querySelector(`[onclick="selectPaymentMethod('${method}')"]`);
            selectedMethod.classList.add('selected');
            
            const radioButton = selectedMethod.querySelector('input[type="radio"]');
            radioButton.checked = true;
            
            // PROBLEMA: Cambio no anunciado
            
            // Mostrar/ocultar detalles de tarjeta
            const cardDetails = document.getElementById('cardDetails');
            if (method === 'card') {
                cardDetails.style.display = 'block';
                // PROBLEMA: No enfoca primer campo de tarjeta
            } else {
                cardDetails.style.display = 'none';
            }
        }
        
        // PROBLEMA: Formateo de tarjeta sin accesibilidad
        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            
            if (formattedValue !== input.value) {
                input.value = formattedValue;
                // PROBLEMA: Cambio no anunciado a lectores de pantalla
            }
            
            updateCardPreview();
            detectCardType(value);
        }
        
        // PROBLEMA: Detectar tipo de tarjeta sin accesibilidad
        function detectCardType(number) {
            let cardType = 'CARD';
            
            if (number.startsWith('4')) cardType = 'VISA';
            else if (number.startsWith('5') || number.startsWith('2')) cardType = 'MASTERCARD';
            else if (number.startsWith('3')) cardType = 'AMEX';
            
            document.getElementById('cardType').textContent = cardType;
            // PROBLEMA: Cambio no anunciado
        }
        
        // PROBLEMA: Vista previa tarjeta sin accesibilidad
        function updateCardPreview() {
            const cardNumber = document.querySelector('[name="cardNumber"]').value || '**** **** **** ****';
            const cardHolder = document.querySelector('[name="cardHolder"]').value.toUpperCase() || 'NOMBRE APELLIDOS';
            const expiryMonth = document.querySelector('[name="expiryMonth"]').value || 'MM';
            const expiryYear = document.querySelector('[name="expiryYear"]').value || 'AA';
            
            document.getElementById('cardNumberDisplay').textContent = cardNumber;
            document.getElementById('cardHolderDisplay').textContent = cardHolder;
            document.getElementById('cardExpiryDisplay').textContent = `${expiryMonth}/${expiryYear.slice(-2)}`;
            
            // PROBLEMA: Cambios visuales no descritos
        }
        
        // PROBLEMA: Ayuda CVV sin accesibilidad
        function showCVVHelp() {
            // PROBLEMA: Alert no accesible
            alert('CVV: C√≥digo de 3 d√≠gitos en la parte trasera de la tarjeta (4 d√≠gitos en American Express)');
        }
        
        // PROBLEMA: Toggle facturaci√≥n sin accesibilidad
        function toggleBillingAddress() {
            const checkbox = document.querySelector('[name="sameAsShipping"]');
            const section = document.getElementById('billingAddressSection');
            
            if (checkbox.checked) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                // PROBLEMA: No enfoca primer campo
            }
            
            // PROBLEMA: Cambio no anunciado
        }
        
        // PROBLEMA: Seleccionar env√≠o sin accesibilidad
        function selectShipping(type) {
            const radio = document.querySelector(`[value="${type}"]`);
            radio.checked = true;
            
            // Actualizar costo
            let cost = 0;
            switch(type) {
                case 'express': cost = 9.99; break;
                case 'overnight': cost = 19.99; break;
            }
            
            document.getElementById('shippingCost').textContent = cost === 0 ? 'Gratis' : `‚Ç¨${cost.toFixed(2)}`;
            
            // PROBLEMA: Cambio de precio no anunciado
        }
        
        // Utilidades - PROBLEMAS
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function isValidCardNumber(number) {
            return /^\d{4}\s?\d{4}\s?\d{4}\s?\d{4}$/.test(number);
        }
        
        // PROBLEMA: Aplicar c√≥digo promocional sin accesibilidad
        function applyPromoCode() {
            const code = document.getElementById('promoCode').value;
            
            if (code === 'DESCUENTO20') {
                // PROBLEMA: √âxito no anunciado apropiadamente
                alert('¬°C√≥digo aplicado! Descuento del 20%');
            } else if (code) {
                // PROBLEMA: Error no accesible
                alert('C√≥digo promocional inv√°lido');
            }
        }
        
        // PROBLEMA: Env√≠o formulario sin accesibilidad
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('checkoutForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateCurrentStep()) {
                    // PROBLEMA: Proceso de pago sin accesibilidad
                    startPaymentProcess();
                }
            });
            
            // PROBLEMA: No configura navegaci√≥n con teclado
            // FALTA: Manejo de teclas Escape, Tab, Enter
            // FALTA: Navegaci√≥n entre pasos con teclado
        });
        
        // PROBLEMA: Proceso de pago sin accesibilidad
        function startPaymentProcess() {
            const overlay = document.getElementById('processingOverlay');
            overlay.style.display = 'flex';
            
            // PROBLEMA: No bloquea interacci√≥n con contenido de fondo
            // PROBLEMA: No maneja foco apropiadamente
            
            // Simular progreso
            const steps = [
                'Validando informaci√≥n...',
                'Procesando pago...',
                'Confirmando transacci√≥n...',
                'Generando pedido...'
            ];
            
            let currentStepIndex = 0;
            const progressBar = document.getElementById('processingProgress');
            const stepText = document.getElementById('processingStep');
            
            const interval = setInterval(() => {
                currentStepIndex++;
                const progress = (currentStepIndex / steps.length) * 100;
                
                progressBar.style.width = progress + '%';
                
                if (currentStepIndex < steps.length) {
                    stepText.textContent = steps[currentStepIndex];
                } else {
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        showSuccessOverlay();
                    }, 1000);
                }
                
                // PROBLEMA: Progreso no anunciado
                
            }, 1500);
        }
        
        // PROBLEMA: Overlay de √©xito sin accesibilidad
        function showSuccessOverlay() {
            const successOverlay = document.getElementById('successOverlay');
            successOverlay.style.display = 'flex';
            
            // PROBLEMA: No enfoca contenido del modal
            // PROBLEMA: No maneja tecla Escape
        }
        
        function closeSuccess() {
            document.getElementById('successOverlay').style.display = 'none';
            // Redirigir o limpiar formulario
            window.location.href = '/';
        }
    </script>
    
</body>
</html>

<!--
PROBLEMAS CR√çTICOS DE ACCESIBILIDAD PARA CORREGIR:

ESTRUCTURA Y NAVEGACI√ìN:
1. ‚úó Falta skip links                                                      (HECHO)
2. ‚úó Proceso de pasos sin landmark apropiado (main)
3. ‚úó Indicadores de progreso sin aria-current
4. ‚úó Formulario sin fieldset/legend para agrupar secciones
5. ‚úó Sidebar resumen sin complementary landmark

MANEJO DE PASOS:
6. ‚úó Cambios de paso no anunciados (aria-live)
7. ‚úó Paneles ocultos sin aria-hidden
8. ‚úó Progreso sin role="progressbar" y valores aria
9. ‚úó Navegaci√≥n entre pasos sin manejo de foco
10. ‚úó Indicador visual sin estado accesible

FORMULARIOS Y CAMPOS:
11. ‚úó Labels no asociados correctamente
12. ‚úó Campos requeridos sin aria-required
13. ‚úó Mensajes de error no asociados (aria-describedby)
14. ‚úó Validaci√≥n sin aria-invalid
15. ‚úó Checkboxes sin labels apropiados

M√âTODOS DE PAGO:
16. ‚úó Opciones de pago sin fieldset/legend
17. ‚úó Cambios de m√©todo no anunciados
18. ‚úó Vista previa de tarjeta solo visual
19. ‚úó CVV help sin implementaci√≥n accesible
20. ‚úó Formateo autom√°tico no anunciado

CONTENIDO DIN√ÅMICO:
21. ‚úó Cambios de precios no anunciados
22. ‚úó Secciones colapsables sin aria-expanded
23. ‚úó Estados de validaci√≥n no comunicados
24. ‚úó Actualizaciones de resumen sin feedback

OVERLAYS Y MODALES:
25. ‚úó Loading overlay sin role="dialog"
26. ‚úó No maneja foco en overlays
27. ‚úó Falta trap de foco en modales
28. ‚úó Progreso de pago no accesible
29. ‚úó Overlays sin aria-labelledby/describedby

INTERACCI√ìN CON TECLADO:
30. ‚úó Navegaci√≥n entre pasos solo con mouse
31. ‚úó Falta manejo de tecla Escape
32. ‚úó M√©todos de pago no navegables con teclado
33. ‚úó Botones personalizados sin eventos de teclado

INFORMACI√ìN TEMPORAL Y ESTADOS:
34. ‚úó Estados de procesamiento no anunciados
35. ‚úó Confirmaciones no accesibles (alert, confirm)
36. ‚úó Cambios de total no comunicados
37. ‚úó C√≥digos promocionales sin feedback apropiado

CONTEXTO Y AYUDA:
38. ‚úó Enlaces externos sin indicaci√≥n
39. ‚úó Campos complejos sin descripci√≥n
40. ‚úó Restricciones de formato no comunicadas
41. ‚úó Ayudas contextuales no asociadas

El equipo debe implementar:
- role="main" para contenido principal
- Indicadores de progreso accesibles (aria-current, progressbar)
- fieldset/legend para agrupar campos relacionados
- Asociaciones correctas label/input
- aria-live regions para cambios din√°micos
- role="dialog" para overlays con trap de foco
- Navegaci√≥n completa con teclado
- aria-expanded para secciones colapsables
- Manejo apropiado de foco entre pasos
- Anuncios de cambios de estado y precios
- Alternativas accesibles para elementos visuales
- Descripciones contextuales para campos complejos
- Estados de validaci√≥n comunicados apropiadamente

ESTE ES EL EJERCICIO M√ÅS COMPLEJO Y DEBE DEMOSTRAR:
- Manejo avanzado de procesos multi-paso
- Comunicaci√≥n de cambios din√°micos complejos
- Gesti√≥n de foco en interfaces complejas
- Implementaci√≥n de patrones ARIA avanzados
-->